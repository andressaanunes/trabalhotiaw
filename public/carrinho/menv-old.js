const me = {
    client_id: '6627',
    sandboxClient_id: '2382',
    client_secret: 'YzXJzwPgW7qy2409KLRqNGPbjwjGnGsvWhkgJbJK',
    sandboxClient_secret: 'rntPjNCA2MKGirRsdDdtHXP1CEXgfEaRVmIcG8ps',
    user_agent : 'CriaLuth kayrodanyell@gmail.com',
    sandbox: false,
    bearer :{
      "token_type": "Bearer",
      "expires_in": 2592000,
      "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6ImQ1NjAxMmJkOWIwMzNjYzQ4OGFiOWU5ZDQxOGQzODBkMWIzYzI1OGY3OTVjODhjZGFjZWZjN2M2YzU2ZjViNTEyZWZjZGQ2NzgwODNhMDExIn0.eyJhdWQiOiIyMzgyIiwianRpIjoiZDU2MDEyYmQ5YjAzM2NjNDg4YWI5ZTlkNDE4ZDM4MGQxYjNjMjU4Zjc5NWM4OGNkYWNlZmM3YzZjNTZmNWI1MTJlZmNkZDY3ODA4M2EwMTEiLCJpYXQiOjE2NDU3MDY2MjIsIm5iZiI6MTY0NTcwNjYyMiwiZXhwIjoxNjQ4Mjk4NjIyLCJzdWIiOiI2ZWVmNTllOS0zOTI3LTQzOTAtYmIyNi02NDAxMDcyZTdmZmYiLCJzY29wZXMiOlsiY2FydC1yZWFkIiwiY2FydC13cml0ZSIsImNvbXBhbmllcy1yZWFkIiwiY29tcGFuaWVzLXdyaXRlIiwiY291cG9ucy1yZWFkIiwiY291cG9ucy13cml0ZSIsIm5vdGlmaWNhdGlvbnMtcmVhZCIsIm9yZGVycy1yZWFkIiwicHJvZHVjdHMtcmVhZCIsInByb2R1Y3RzLXdyaXRlIiwicHVyY2hhc2VzLXJlYWQiLCJzaGlwcGluZy1jYWxjdWxhdGUiLCJzaGlwcGluZy1jYW5jZWwiLCJzaGlwcGluZy1jaGVja291dCIsInNoaXBwaW5nLWNvbXBhbmllcyIsInNoaXBwaW5nLWdlbmVyYXRlIiwic2hpcHBpbmctcHJldmlldyIsInNoaXBwaW5nLXByaW50Iiwic2hpcHBpbmctc2hhcmUiLCJzaGlwcGluZy10cmFja2luZyIsImVjb21tZXJjZS1zaGlwcGluZyIsInRyYW5zYWN0aW9ucy1yZWFkIiwidXNlcnMtcmVhZCIsInVzZXJzLXdyaXRlIl19.I655xEJ6a5fY2hm7h4St6BcyRDiJTtKBmX2j51HEepbBhxWMFf3T7yGA7oGztI75WiFqYJb6-qDbH0lEg0a8pjdnODqP3muFiUJ20ssA9rPlJ6IHjqx1Fq1l8ce7jvbILI4u116bn8DRoY_OsuJmWC77IM-uU02sBmj_muN2xVyfPfgqg6TCmPH4NoXFTI_VATJBJmUsYj58pAGiA8bESblvtIsa5r-zwXg_rHLuN_TrkqJ58JqnnS2CXi-sqP-luCfRV8ro_6secrIjuiNbJ3_VdCzcLgRLXO9MXDzeEkRc3MP-O3XBAJIJa23-HDNzRjafmftsmsRQa7wSG-hDnBpatmS42cncuV113YBqklpIhGiGnc5S6x30yYCJjpWc6kJmAJIfMykRuV1M-V656Dia6scqE-y7R2mIP3Q83pJq9QwyyIgJVVy9HGRR06yXMh4BvIHAWfBvgOvFbtNen9gwXTd5chN_znmJM4cA3ObLK86txibuhuNElULeEWAVkce8vbH1Cm5IjkBJgdw-5KlbWkxr66oJdSLaqXY3lVrulm5YXG0wT7Z8HQPw0RAATNvoC1EmrkoGR6sn0_fh7v3AInp8zdf8qyRbxBrigMSaz_3kw486EaF5cI48PTFGfVkNS6YjHOzXZUh93gMRZ4gprLcdgG1D69lDJa6S83k",
      "refresh_token": "def502008408f60dbd6940dfa38820b113a523c4044d243e6f48638c9d7ce3f969f55aaf7f24876432d75f86bec67a13b92df7468715434772bc6e97341c09b1cb6262e78544c030d8b02a701f5991dc09f823f4633e5e9ddf949c5a2be5ef65945c93c9a02e78d9d2b9e124329fbcfac1c4cb1fe0709f93af97822b26e332e4db51899b2ba2c11c0db0c710421fbcfdf5bc08b3220bdba037c4b827a37a6f2c9c43ece22717f7b7a4f78ba254665667477d2ea98fa3ec18f0be6a0183081f2bf3d83fa548e5403d8db9ad664e93ced87373bdf91ae83f7f9e5560e7637e8636fcdf8570ac15070a145eac52d84f74aeedeff5ecf9c756ad3dae007ad5800e903fc5c079d09b283857a13652458eafc5c7818bebe6319aacbe5171d74f5ac4a7a48f49e75873cd70e729a5474beddf197f0711a35e437e7b7b872f9bf384ce851e32f30c8d9c6f048b5e2155c2d724ffd10dbe0e0fdf6645858e0d7504a73239f7ef39a95f19f387ef8763d563934f53a06d87c754350c56d4ca0e3920edf791e63ca47d5b9ad99c0f3a2bf2ebbc37d49fb5668cc7f500991d9a1696cf5167ea75612593527608991fd3d27f3e1e7ba7b772aa0dffeeebebbd7cbdefab86d7680a3d3a2448e5bae24fc656acc02cf71a6f93461ad0111d85bab49023869da733ad2c9c8523e8b4f8b317b73c8554bb0b4ea190cd5e8d4b0657647ac45a5b0ef1af2d49b14bc70c600fdae2ea95d8024d765b042ea635fee4ad563178f9250e7e3fdc0c8fae4233be1d0d9fd2c84397280cf25443a1af19a1be3e4990d2362359beb585e4cbaf1b8ba2d7496e9c15e4859276afee9a37dfc8bca74015320dcf8bb1d22dd51307b56ce33e0bcda0053a32a8ed243cc13a08db677e7169796e024db39a8b08551cab8de259d8884c56fb0771afff250de77b17600e130f3da9e49c17c7ac1d5ef843760bcc662e84994d55abdb24381655f778db72f4d167f59eef16f4cce90f18d6839c1c3bb0a4cdeff7dea2db0f94ee14265a5833eb161e610c9a04918e8d8f873f405f66d8f8a79ef16d780d3375952c074bff7709d6356066e016a57b1d77fc569d0c0b0d5a0d14007067147043617b239357d2916522461ac2a166a008dd4c0dbe"
    },
    redirect_uri: 'https://www.crialuth.com/shiptoken',
    url : 'https://www.melhorenvio.com.br',
    sandboxUrl : 'https://sandbox.melhorenvio.com.br',
    scope:'cart-read cart-write companies-read companies-write coupons-read coupons-write notifications-read orders-read products-read products-write purchases-read shipping-calculate shipping-cancel shipping-checkout shipping-companies shipping-generate shipping-preview shipping-print shipping-share shipping-tracking ecommerce-shipping transactions-read users-read users-write webhooks-read webhooks-write'
  }  
  
async function buscaToken(){

    const token = await fetch('https://www.crialuth.com/getToken');
    console.log(token)
    me.bearer = token   

}

async function checkTokenExp(){    
 
  /* let tokenObj = await apiTokens.findAll({
    where: {
        api: "menv"
        }
    }).then(res => {
      console.log('res',res)
      return res[0]
    })
 */
   let tokenObj = buscaToken()
  //console.log('TOKENOBJ  ='+ tokenObj)    
  let date = dayjs().format('YYYY-MM-DD')
  let isSame = date === tokenObj.expDate ? true : false
  //console.log(date)
  //console.log(tokenObj.expDate)
  console.log(isSame)

  if (isSame) {

    await refreshToken()
    
  }else{

    return isSame // false

  }


}



async function getToken(code){
  //https://sandbox.melhorenvio.com.br/oauth/authorize?client_id=2382&redirect_uri=https://www.crialuth.com/shiptoken&response_type=code&scope=cart-read cart-write companies-read companies-write coupons-read coupons-write notifications-read orders-read products-read products-write purchases-read shipping-calculate shipping-cancel shipping-checkout shipping-companies shipping-generate shipping-preview shipping-print shipping-share shipping-tracking ecommerce-shipping transactions-read users-read users-write
  var myHeaders = new Headers();
  myHeaders.append("Accept", "application/json");
  myHeaders.append("User-Agent", me.user_agent);

  var formdata = new FormData();
  formdata.append("grant_type", "authorization_code");
  formdata.append("client_id", me.sandboxClient_id);
  formdata.append("client_secret", me.sandboxClient_secret);
  formdata.append("redirect_uri", me.redirect_uri);
  formdata.append("code", code);

  var requestOptions = {
    method: 'POST',
    headers: myHeaders,
    body: formdata,
    redirect: 'follow'
  };

  const tokenRes = fetch(`${me.sandboxUrl}/oauth/token`, requestOptions)
  console.log(tokenRes)
  localStorage.setItem('tokenMenv',tokenRes)

}


async function refreshToken(){
    console.log('====================== chegou no refreshtoken =============================')
    try {
        const myHeaders = new Headers();
        myHeaders.append("Accept", "application/json");
        myHeaders.append("User-Agent", me.user_agent);

        const formdata = new FormData();
        formdata.append("grant_type", "refresh_token");
        formdata.append("refresh_token", me.bearer.refresh_token);
        formdata.append("client_id", me.sandboxClient_id);
        formdata.append("client_secret", me.sandboxClient_secret);

        var requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: formdata,
            redirect: 'follow'
        };

        var response = await fetch(`${me.sandboxUrl}/oauth/token`, requestOptions)
        console.log('ResponseRefreshToken'+response);

        config = {
            method: "POST",
            headers: new Headers({'Content-Type' : 'application/json'}),
            body:response
        }
        var tokenRefreshed = await fetch('https://www.crialuth.com/refreshshiptoken', config)
        console.log('tokenRefreshed'+tokenRefreshed)
        console.log('tokenRefreshed'+JSON.stringify(tokenRefreshed))
     
        await buscaToken()
        return true

    }catch (error) {
  
      console.log(error)
      return error
  
    }
    
  }

async function shipCalc(senderCEP,receiverCEP,quant){
  checkTokenExp()
  try{ 
    var peso = parseFloat(quant * 0.5)
    console.log('peso: '+peso)

    if (quant <= 3 ){

    var boxDimens = {

        "height": 19,
        "width": 28,
        "length": 36,
        "weight": peso
    }//! ADAPTAR PARA RECEBER PEDIDOS Q PRECISEM DE MAIS DE 1 PACOTE

  }else if(quant <= 10){

    var boxDimens = {
      "height": 23,
      "width": 40,
      "length": 29,
      "weight": peso
    }
  }  

  var payload = {
    "from": {
      "postal_code": senderCEP
    },
    "to": {
      "postal_code": receiverCEP
    },
    "package": boxDimens//! ADICIONAR CONFIGURAÃ‡Ã‚O PARA MAIS DE 1 CAIXA
  }
    console.log("payload: ", JSON.stringify(payload))
    const myHeaders = new Headers();
    myHeaders.append("Accept", "application/json");
    myHeaders.append("Content-Type", "application/json");
    myHeaders.append("Authorization", `Bearer ${me.bearer.access_token}`);
    myHeaders.append("User-Agent", me.user_agent);
    myHeaders.append("Access-Control-Allow-Origin","*")

    var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: JSON.stringify(payload),
        redirect: 'follow'
      };
      
    var response = await fetch(`${me.sandboxUrl}/api/v2/me/shipment/calculate`, requestOptions)
    let res = await response.json()
    console.log('res: ', res)

    if(res.message  == 'Unauthenticated'){

      checkTokenExp()

      response = await shipCalc(senderCEP,receiverCEP,quant)

    }

    console.log(response.data)
    //console.log('response json',res)
    //console.log(JSON.stringify(response))
    return response
  }catch(error){
      console.log(error)
      return error
  }
    
}



async function shipCartReq(info){
    
    checkTokenExp()
  
    try{
      console.log(info)

      const myHeaders = new Headers();
      myHeaders.append("Accept", "application/json");
      myHeaders.append("Content-Type", "application/json");
      myHeaders.append("Authorization", `Bearer ${me.bearer.access_token}`);
      myHeaders.append("User-Agent", me.user_agent);
      myHeaders.append("Access-Control-Allow-Origin","*")

      var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: JSON.stringify(info),
        redirect: 'follow'
      };
      
      let res = await fetch(`${me.sandboxUrl}/api/v2/me/cart`, requestOptions)
      console.log(res) 
      
      if(res.message  == 'Unauthenticated'){

        checkTokenExp()
  
        res = await shipCartReq(info)
  
      }

      const respo = await shipCheckout(res.id)
      return {'respocheckout':respo,'resCart':res} 
    }catch(error){
      
      console.log(error.response.data)
  
    }
    
  }
  
  async function shipCheckout(id){

    checkTokenExp()
    
    var data = {
      "orders": [
        id 
      ]    
    }

    var config = {

      method: 'post',
      url: `${me.sandboxUrl}/api/v2/me/shipment/checkout`,
      headers: { 
        'Accept': 'application/json', 
        'Content-Type': 'application/json', 
        'Authorization': 'Bearer '+me.bearer.access_token, 
        'User-Agent': me.user_agent
      },
      data : data

    };
  
    try {
      
      let respo = await fetch(`${me.sandboxUrl}/api/v2/me/shipment/checkout`, config)

      if(respo.message  == 'Unauthenticated'){
        checkTokenExp()
        respo = await shipCheckout(id)
      }

      console.log('RESPOTA SHIPCHECKOUT',respo)
      return respo
  
    }catch(error){
      
      console.log(error)
    }
    
  }
  
  async function menvShipCheckout(id){

    var data = {
      "orders": [
        id 
      ]    
    }
    var checkout = await me.shipment.checkout(data,me.bearer)
    console.log("ðŸš€ ~ file: melhorenvio.js ~ line 329 ~ menvShipCheckout ~ checkout", checkout)
    return checkout
    
  }

async function appInfo(){
  let myHeaders = new Headers();
  myHeaders.append("Accept", "application/json");
  myHeaders.append("Authorization", `Bearer ${me.bearer.access_token}`);
  myHeaders.append("User-Agent", me.user_agent);
  
  let requestOptions = {
    method: 'GET',
    headers: myHeaders,
    redirect: 'follow'
  };
  
  fetch(`${me.sandboxUrl}/api/v2/me/shipment/app-settings`, requestOptions)
    .then(response => response.text())
    .then(result => console.log(result))
    .catch(error => console.log('error', error));

}


export {appInfo,shipCalc,shipCartReq,menvShipCheckout,refreshToken}